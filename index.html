<!doctype html>
<html lang="lt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>loxqty — Išmanaus namo sąmatų braižyklė</title>
  <link rel="stylesheet" href="style.css" />
  <script type="module">
    // PDF.js loader: local vendor first, then CDN fallbacks
    async function loadPdfJs() {
      const tries = [
        './vendor/pdf.mjs',
        'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.mjs',
        'https://unpkg.com/pdfjs-dist@4.4.168/build/pdf.mjs'
      ];
      let lastErr=null;
      for (const url of tries) {
        try {
          const mod = await import(url);
          mod.GlobalWorkerOptions.workerSrc = url.replace('pdf.mjs','pdf.worker.mjs');
          console.log('[pdfjs] loaded from', url);
          return mod;
        } catch (e) { lastErr=e; console.warn('[pdfjs] fail', url, e?.message||e); }
      }
      throw lastErr || new Error('Nepavyko užkrauti PDF.js');
    }
    window.__pdfReady = loadPdfJs().then(m => window.pdfjsLib=m);
  </script>
</head>
<body>
  <header>
    <h1>loxqty</h1>
    <div class="actions">
      <label class="button">
        Įkelti PDF
        <input id="pdfFile" type="file" accept="application/pdf,.pdf" hidden />
      </label>
      <button id="prevPage" title="Ankstesnis puslapis">◀</button>
      <span id="pageInfo">—</span>
      <button id="nextPage" title="Kitas puslapis">▶</button>
      <button id="setScale" title="Nustatyti mastelį">Mastelis</button>
      <button id="exportCSV" title="Eksportuoti kiekius (CSV)">CSV</button>
      <button id="exportPNGs" title="PNG (visi puslapiai)">PNG</button>
      <button id="exportPDF" title="PDF (per spausdinimą)">PDF</button>
      <button id="saveProject" title="Išsaugoti projektą su PDF">Išsaugoti projektą</button>
      <label class="button">
        Įkelti projektą
        <input id="loadProject" type="file" accept="application/json" hidden />
      </label>
      <div class="split"></div>
      <button id="downloadOriginal">Atsisiųsti PDF</button>
      <button id="openCatalog">Katalogas…</button>
      <button id="exportCatalog">Katalogas → JSON</button>
      <label class="button button-outline">
        Įkelti katalogą
        <input id="importCatalog" type="file" accept="application/json" hidden />
      </label>
    </div>
  </header>

  <main>
    <aside>
      <h2>Katalogas</h2>

      <div class="tree-filters">
        <label>Grupė
          <select id="fCat"></select>
        </label>
        <label>Šeima
          <select id="fFamily"></select>
        </label>
        <label>Spalva
          <select id="fColor"></select>
        </label>
      </div>

      <div id="catalog" class="catalog"></div>

      <div class="hr"></div>
      <div class="tools">
        <h2>Įrankiai</h2>
        <label><input id="snap" type="checkbox" checked> Tvirtinti prie 45°/90° (linijoms)</label><br/>
        <button id="undo">Atšaukti</button>
        <button id="clearPage">Išvalyti puslapį</button>
        <p class="hint">
          • Pasirink elementą ir spausk ant plano — padėsi žymą.<br/>
          • Laikyk <b>Shift</b> ir vilk — braižyk liniją (pvz., kabelį).<br/>
          • <b>Dešinis</b> pelės ant žymos — trinti.<br/>
          • <b>Option/Alt</b> + vilk — perkelti žymą.
        </p>
      </div>

      <div class="hr"></div>
      <h2>Mastelis</h2>
      <p>Dabartinis: <span id="scaleLabel">nenustatytas</span></p>

      <div class="hr"></div>
      <h2>Kiekiai</h2>
      <table id="totals">
        <thead><tr><th>Tipas</th><th>Gamintojo kodas</th><th>Vnt</th><th>€/vnt</th><th>Suma</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><td colspan="4" style="text-align:right"><b>Iš viso</b></td><td id="grandTotal">0</td></tr></tfoot>
      </table>

      <div class="hr"></div>
      <div id="status" class="status">Status: laukiu PDF…</div>
    </aside>

    <section id="stage">
      <div id="dropHint" class="drop-hint">Įkelk PDF (arba vilk–n–mesk čia)</div>
      <canvas id="pdfCanvas"></canvas>
      <canvas id="annoCanvas"></canvas>
      <div id="tooltip" class="tooltip" hidden></div>
    </section>
  </main>

  <!-- Catalog editor modal -->
  <dialog id="catalogModal">
    <form method="dialog" class="catalog-form" id="catalogForm">
      <h3>Katalogo redagavimas</h3>
      <table class="cat-table">
        <thead>
          <tr>
            <th>ID</th><th>Pavadinimas</th><th>Grupė</th><th>Šeima</th><th>Spalva</th>
            <th>Gam. kodas</th><th>Vnt</th><th>Kaina</th><th>Ikona</th><th></th>
          </tr>
        </thead>
        <tbody id="catRows"></tbody>
      </table>
      <div class="row">
        <button type="button" id="addRow">Pridėti</button>
        <div class="spacer"></div>
        <button type="submit" class="primary">Išsaugoti</button>
        <button type="button" id="cancelModal">Uždaryti</button>
      </div>
    </form>
  </dialog>

  <script type="module" src="app.js"></script>
</body>
</html>
