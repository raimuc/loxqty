<!doctype html>
<html lang="lt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>loxqty — On/Off → Relay Extension (14)</title>
  <link rel="stylesheet" href="style.css" />
  <script type="module">
    // PDF.js loader: local first, then CDN fallbacks
    async function loadPdfJs() {
      const tries = [
        './vendor/pdf.mjs',
        'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.mjs',
        'https://unpkg.com/pdfjs-dist@4.4.168/build/pdf.mjs'
      ];
      let lastErr=null;
      for (const url of tries) {
        try {
          const mod = await import(url);
          const worker = url.replace('pdf.mjs', 'pdf.worker.mjs');
          mod.GlobalWorkerOptions.workerSrc = worker;
          console.log('[pdfjs] loaded from', url);
          return mod;
        } catch(e){ lastErr=e; console.warn('[pdfjs] failed', url, e?.message||e); }
      }
      throw lastErr || new Error('Nepavyko užkrauti PDF.js');
    }
    loadPdfJs().then(m => window.pdfjsLib=m).catch(err => {
      console.error(err);
      alert('PDF.js neįkeltas. Įkelk vendor/pdf.mjs ir vendor/pdf.worker.mjs arba patikrink internetą.');
    });
  </script>
</head>
<body>
  <header>
    <h1>loxqty</h1>
    <div class="actions">
      <label class="button">
        Įkelti PDF
        <input id="pdfFile" type="file" accept="application/pdf,.pdf" hidden />
      </label>
      <button id="prevPage">◀</button><span id="pageInfo">—</span><button id="nextPage">▶</button>
      <button id="setScale">Mastelis</button>
      <button id="exportCSV">CSV</button>
      <button id="exportPNGs">PNG</button>
      <button id="exportPDF">PDF</button>
      <button id="saveProject">Išsaugoti projektą</button>
      <label class="button">
        Įkelti projektą
        <input id="loadProject" type="file" accept="application/json" hidden />
      </label>
      <button id="openCatalog">Katalogas…</button>
    </div>
  </header>

  <main>
    <aside>
      <h2>Filtrai</h2>
      <div class="filters">
        <select id="fGroup"><option value="">Grupė</option></select>
        <select id="fFamily"><option value="">Šeima</option></select>
        <select id="fColor"><option value="">Spalva</option></select>
      </div>
      <div id="catalog" class="catalog"></div>
      <div class="hr"></div>
      <div class="tools">
        <label><input id="snap" type="checkbox" checked> Snap 45°/90°</label>
        <button id="undo">Atšaukti</button>
        <button id="clearPage">Išvalyti puslapį</button>
      </div>
      <div class="hr"></div>
      <h2>Kiekiai</h2>
      <table id="totals">
        <thead><tr><th>SKU</th><th>Tipas</th><th>Vnt</th><th>€/vnt</th><th>Suma</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><td colspan="4" style="text-align:right"><b>Iš viso</b></td><td id="grandTotal">0</td></tr></tfoot>
      </table>
      <div class="hr"></div>
      <div id="status" class="status">Status: laukiu PDF…</div>
    </aside>

    <section id="stage">
      <div id="dropHint" class="drop-hint">Įkelk PDF (arba vilk–n–mesk čia)</div>
      <canvas id="pdfCanvas"></canvas>
      <canvas id="annoCanvas"></canvas>
      <div id="tooltip" class="tooltip" hidden></div>
    </section>
  </main>

  <dialog id="catalogModal">
    <form method="dialog" id="catalogForm" class="catalog-form">
      <h3>Katalogo redagavimas</h3>
      <table class="cat-table">
        <thead><tr><th>ID</th><th>SKU</th><th>Pavadinimas</th><th>Grupė</th><th>Šeima</th><th>Spalva</th><th>Vnt</th><th>Kaina</th><th>Ikona</th><th></th></tr></thead>
        <tbody id="catRows"></tbody>
      </table>
      <div class="row">
        <button type="button" id="addRow">Pridėti</button>
        <div class="spacer"></div>
        <button type="submit" class="primary">Išsaugoti</button>
        <button type="button" id="closeModal">Uždaryti</button>
      </div>
    </form>
  </dialog>

  <script type="module" src="app.js"></script>
</body>
</html>
