<!doctype html>
<html lang="lt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>loxqty — sąmatų braižyklė</title>
  <link rel="stylesheet" href="style.css" />
  <script type="module">
    // PDF.js dynamic loader: try local vendor, then CDN fallbacks
    async function loadPdfJs() {
      const tries = [
        './vendor/pdf.mjs',
        'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.mjs',
        'https://unpkg.com/pdfjs-dist@4.4.168/build/pdf.mjs'
      ];
      let lastErr;
      for (const url of tries) {
        try {
          const mod = await import(url);
          mod.GlobalWorkerOptions.workerSrc = url.replace('pdf.mjs', 'pdf.worker.mjs');
          console.log('[pdfjs] loaded from', url);
          return mod;
        } catch (e) {
          console.warn('[pdfjs] failed', url, e?.message || e);
          lastErr = e;
        }
      }
      throw lastErr || new Error('Nepavyko užkrauti PDF.js');
    }
    const pdfReady = loadPdfJs().then(m => (window.pdfjsLib = m));
    window.__pdfReady = pdfReady;
  </script>
</head>
<body>
  <header>
    <h1>loxqty</h1>
    <div class="actions">
      <label class="button">
        Įkelti PDF
        <input id="pdfFile" type="file" accept="application/pdf,.pdf" hidden />
      </label>
      <button id="prevPage">◀</button>
      <span id="pageInfo">—</span>
      <button id="nextPage">▶</button>
      <button id="setScale">Mastelis</button>
      <button id="exportCSV">CSV</button>
      <button id="exportPNGs">PNG</button>
      <button id="exportPDF">PDF</button>
      <button id="saveProject">Išsaugoti projektą</button>
      <label class="button">
        Įkelti projektą
        <input id="loadProject" type="file" accept="application/json" hidden />
      </label>
      <div class="split"></div>
      <button id="openCatalog">Katalogas…</button>
    </div>
  </header>

  <main>
    <aside>
      <h2>Elementų katalogas</h2>
      <div class="filters">
        <select id="fGroup"><option value="">Grupė</option></select>
        <select id="fFamily"><option value="">Šeima</option></select>
        <select id="fColor"><option value="">Spalva</option></select>
      </div>
      <div id="catalog" class="catalog"></div>

      <div class="hr"></div>
      <div class="tools">
        <h2>Įrankiai</h2>
        <label><input id="snap" type="checkbox" checked> Tvirtinti prie 45°/90° (linijoms)</label><br/>
        <button id="undo">Atšaukti</button>
        <button id="clearPage">Išvalyti puslapį</button>
      </div>

      <div class="hr"></div>
      <h2>Mastelis</h2>
      <p>Dabartinis: <span id="scaleLabel">nenustatytas</span></p>

      <div class="hr"></div>
      <h2>Kiekiai</h2>
      <table id="totals">
        <thead><tr><th>SKU</th><th>Pavadinimas</th><th>Vnt</th><th>€/vnt</th><th>Suma</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><td colspan="4" style="text-align:right"><b>Iš viso</b></td><td id="grandTotal">0</td></tr></tfoot>
      </table>

      <div class="hr"></div>
      <div id="status" class="status">Status: laukiu PDF…</div>
    </aside>

    <section id="stage">
      <div id="dropHint" class="drop-hint">Įkelk PDF (arba vilk–n–mesk čia)</div>
      <canvas id="pdfCanvas"></canvas>
      <canvas id="annoCanvas"></canvas>
      <div id="tooltip" class="tooltip" hidden></div>
    </section>
  </main>

  <!-- Catalog modal -->
  <dialog id="catalogModal">
    <form method="dialog" class="catalog-form" id="catalogForm">
      <h3>Katalogo redagavimas (su „capacity“ ir paveiksliukų miniatiūromis)</h3>
      <p class="hint">
        <b>Capacity</b>: nurodyk <code>capKey</code> (pvz., relay/dali) ir <code>capSize</code> (pvz., 14/64).<br/>
        <b>Device</b>: nurodyk <code>requires</code> JSON, pvz. <code>[{"type":"capacity","cap":"relay","per":1}]</code>.
      </p>
      <table class="cat-table">
        <thead>
          <tr>
            <th>ID</th><th>SKU</th><th>Tipas</th><th>Pavadinimas</th><th>Grupė</th><th>Šeima</th><th>Spalva</th><th>Vnt</th><th>Kaina</th><th>Ikona</th>
            <th>IMG</th><th>Perž.</th><th>capKey</th><th>capSize</th><th>requires (JSON)</th><th></th>
          </tr>
        </thead>
        <tbody id="catRows"></tbody>
      </table>
      <div class="row">
        <button type="button" id="addDevice">+ Įrenginys</button>
        <button type="button" id="addCapacity">+ Capacity</button>
        <div class="spacer"></div>
        <button type="submit" class="primary">Išsaugoti</button>
        <button type="button" id="closeModal">Uždaryti</button>
      </div>
    </form>
  </dialog>

  <script type="module" src="app.js"></script>
</body>
</html>
